{% extends "dashboard/base.html" %}  
{% load static %}


<!---  PAGE_TITLE  ----------------------------- -->
{% block    PAGE_TITLE  %} 
{% comment %} <h5> Sign Up  <h5> {% endcomment %}
{% endblock PAGE_TITLE  %}  


<!---  MESSAGES_CONTENTS  ---------------------- -->
{% block    MESSAGES_CONTENTS  %}

  <!---  Show The Alert Message  ----------------------------- -->
	{% include 'aler_messages/alert_message.html'%}

{% endblock MESSAGES_CONTENTS  %}  



<!---  CONTENTS_PAGE --------------------------- -->
{% block    CONTENTS_PAGE %} 
{% comment %} 
{% extends 'base.html' %}
{% load static %}
{% block title %} Shopping Cart {% endblock %}

{% block css %}
{% endblock %}
{% block body %} {% endcomment %}
<div class="container-fluid row">
    <div class="col-lg-12">
        <div class="box-element">
            <a href="/" class="btn btn-outline-dark">&#x2190 Continue Shopping</a>
            <br><br>
            <table class="table">
                <tr>
                    <th>
                        <h5>Items: <strong>{{order.get_cart_items}}</strong></h5>
                    </th>
                    <th>
                        <h5>Total: <strong>₹{{order.get_cart_total}}</strong></h5>
                    </th>
                    <th><a href="/checkout/" class="btn btn-success" style="float: right; margin: 5px;">Checkout</a>
                    </th>
                </tr>
            </table>
        </div>
<br>
        <div class="box-element">
            <div class="cart-row">
                <div style="flex: 2;"><strong>Image</strong></div>
                <div style="flex: 2;"><strong>Item</strong></div>
                <div style="flex: 1;"><strong>Price</strong></div>
                <div style="flex: 1;"><strong>Quantity</strong></div>
                <div style="flex: 1;"><strong>Total</strong></div>
            </div>
        {% for item in items %}
            <div class="cart-row">
                <div style="flex: 2;"><img class="row-image" src="{{item.product.image.url}}" alt=""></div>
                <div style="flex: 2;">{{item.product.name}}</div>
                <div style="flex: 1;">₹{{item.product.price}}</div>
                <div style="flex: 1;">
                <p class="quantity">{{item.quantity}}</p>
                <div class="quantity">
                    <img data-product="{{item.product.id}}" data-action="add" src="{% static 'increase.png' %}" class="chg-quantity update-cart" alt="">
                    <img data-product="{{item.product.id}}" data-action="remove" src="{% static 'decrease.png' %}" class="chg-quantity update-cart" alt="">
                </div>
                </div>
                <div style="flex: 1;">₹{{item.get_total}}</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

<script>
    var user = '{{request.user}}'

    function getToken(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getToken('csrftoken');

    function getCookie(name) {
        // Split cookie string and get all individual name=value pairs in an array
        var cookieArr = document.cookie.split(";");

        // Loop through the array elements
        for (var i = 0; i < cookieArr.length; i++) {
            var cookiePair = cookieArr[i].split("=");

            /* Removing whitespace at the beginning of the cookie name
            and compare it with the given string */
            if (name == cookiePair[0].trim()) {
                // Decode the cookie value and return
                return decodeURIComponent(cookiePair[1]);
            }
        }

        // Return null if not found
        return null;
    }
    var cart = JSON.parse(getCookie('cart'))

    if (cart == undefined) {
        cart = {}
        console.log('Cart Created!', cart)
        document.cookie = 'cart=' + JSON.stringify(cart) + ";domain=;path=/"
    }
    console.log('Cart:', cart)

    var updateBtns = document.getElementsByClassName('update-cart')

    for (var i = 0; i < updateBtns.length; i++) {
        updateBtns[i].addEventListener('click', function () {
            var productID = this.dataset.product
            var action = this.dataset.action
            console.log('productId:', productID, 'action:', action)
            console.log('USER:', user)
            if (user == 'AnonymousUser') {
                addCookieItem(productID, action)
            } else {
                updateUserOrder(productID, action)
            }
        })
    }

    function addCookieItem(productID, action) {
        console.log('Not logged in')
        if (action == 'add') {
            if (cart[productID] == undefined) {
                cart[productID] = { 'quantity': 1 }

            } else {
                cart[productID]['quantity'] += 1
            }
        }

        if (action == 'remove') {
            cart[productID]['quantity'] -= 1

            if (cart[productID]['quantity'] <= 0) {
                console.log('Item should be deleted')
                delete cart[productID];
            }
        }
        console.log('Cart:', cart)
        document.cookie ='cart=' + JSON.stringify(cart) + ";domain=;path=/"
        location.reload()
    }

    function updateUserOrder(productID, action) {
        console.log('User is logged in, sending data...')
        var url = '/update_item/'
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({ 'productID': productID, 'action': action })
        })
            .then((response) => {
                return response.json()
            })

            .then((data) => {
                console.log('data:', data)
                location.reload()
            })
    }

</script>

{% endblock CONTENTS_PAGE %} 



<!---  PAGINATION --------------------------- -->
{% block    PAGINATION %} 
{% endblock PAGINATION %} 
